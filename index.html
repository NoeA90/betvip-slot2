/* ========= AUDIO (deja tus variables como estaban) ========= */
const tickEveryMs = 90;
let tickTimer=null;
function startTicks(){ if(!soundOn) return; stopTicks(); tickTimer=setInterval(()=>{ try{tickSfx.currentTime=0;tickSfx.play()}catch(e){} },tickEveryMs); }
function stopTicks(){ if(tickTimer){ clearInterval(tickTimer); tickTimer=null; } }

/* ========= CONFETTI simple ========= */
const fxCanvas = document.getElementById('fx');
const fctx = fxCanvas.getContext('2d');
function resizeFx(){ const r=fxCanvas.getBoundingClientRect(); fxCanvas.width=r.width*devicePixelRatio; fxCanvas.height=r.height*devicePixelRatio; fctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
addEventListener('resize',resizeFx); resizeFx();

function burstConfetti(){
  const N=120, parts=[];
  for(let i=0;i<N;i++){
    parts.push({
      x: fxCanvas.width/2 + (Math.random()*80-40),
      y: fxCanvas.height*0.15,
      vx: (Math.random()*4-2), vy: (Math.random()*-4-3),
      g: 0.12+Math.random()*0.08, life: 60+Math.random()*30,
      c: `hsl(${Math.random()*360},90%,55%)`, s: 3+Math.random()*3, a:1
    });
  }
  let id; (function frame(){
    fctx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    let alive=false;
    for(const p of parts){
      if(p.life>0){ alive=true; p.life--; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a=Math.max(0,p.life/90);
        fctx.globalAlpha=p.a; fctx.fillStyle=p.c; fctx.fillRect(p.x,p.y,p.s,p.s*1.6);
      }
    }
    fctx.globalAlpha=1;
    if(alive) id=requestAnimationFrame(frame); else cancelAnimationFrame(id);
  })();
}

/* ========= SPIN calibrado (reemplazo) ========= */
function spin(){
  if(spinning) return;
  spinning=true;

  // elegimos ganador
  const idx = Math.floor(Math.random()*prizes.length);

  // Ãngulo ABSOLUTO del centro del gajo (con offset -90Â° en el dibujo)
  const center = (idx + 0.5)*seg - 90;      // -90..270

  // Queremos que ese centro quede en 0Â° (punta hacia arriba).
  // La rueda rota en sentido horario con valores positivos.
  // RotaciÃ³n final modular:
  const align = (360 - ((center%360)+360)%360) % 360;

  // 6 vueltas + alineaciÃ³n exacta
  const finalRot = (totalRot + 360*6 + align) % 360;
  totalRot = finalRot;

  rotor.style.transition = 'transform 2.6s cubic-bezier(.2,.85,.2,1)';
  rotor.style.transform  = `rotate(${totalRot}deg)`;

  if(soundOn){ try{spinSfx.currentTime=0;spinSfx.play()}catch(e){} }
  startTicks();

  setTimeout(()=>{
    rotor.style.transition='transform 0s';
    rotor.style.transform = `rotate(${totalRot}deg)`;
    stopTicks();

    // seguridad: re-calc Ã­ndice por Ã¡ngulo final
    const angleAtPointer = ((-totalRot)%360+360)%360;     // 0..359
    let calcIdx = Math.floor(((angleAtPointer + 90) % 360)/seg);
    if(calcIdx<0) calcIdx=0; if(calcIdx>=prizes.length) calcIdx=prizes.length-1;

    const prize = prizes[calcIdx];

    document.getElementById('badge').textContent = prize;
    document.getElementById('resultTitle').textContent = 'ðŸŽ‰ Â¡Premio obtenido!';
    document.getElementById('resultText').innerHTML = `RecibÃ­s <b>${prize}</b> en tu prÃ³xima carga.`;

    if(soundOn){ try{winSfx.currentTime=0;winSfx.play()}catch(e){} }
    burstConfetti();            // ðŸŒˆ confetti
    spinning=false;
  },2600);
}
